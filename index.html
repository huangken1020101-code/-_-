<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>æ‰‹æ©Ÿå¡”é˜²ï¼ˆå®Œæ•´å¯ç©ç‰ˆï¼‰</title>
<style>
body{margin:0;background:#222;color:#fff;font-family:Arial;text-align:center}
canvas{background:#111;border:2px solid #555;width:100vw;max-width:600px;display:block;margin:0 auto}
button{padding:6px 10px;margin:3px;font-size:14px}
#menu{height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center}
#ui{display:flex;justify-content:space-around;margin:6px 0}
#towerBar{display:flex;justify-content:center;flex-wrap:wrap;margin:4px}
#towerBar button.active{border:2px solid #0f0}
#upgradeBox{
 display:none;position:fixed;left:50%;top:50%;
 transform:translate(-50%,-50%);
 background:#333;border:2px solid #aaa;
 padding:12px;z-index:999
}
</style>
</head>
<body>

<!-- ä¸»é¸å–® -->
<div id="menu">
<h2>ğŸ“± æ‰‹æ©Ÿå¡”é˜²</h2>
<div>ä»£å¹£ï¼š<span id="token">0</span></div>
<div>æ“æœ‰å¡”ï¼š<span id="owned"></span></div>
<button onclick="openGacha()">ğŸ° æŠ½å¡ï¼ˆ50ï¼‰</button>
<button onclick="startGame()">â–¶ é–‹å§‹éŠæˆ²</button>
</div>

<!-- éŠæˆ²ç•«é¢ -->
<div id="game" style="display:none">
<div id="ui">
é‡‘éŒ¢:<span id="gold">300</span> |
ç”Ÿå‘½:<span id="life">10</span> |
Wave:<span id="wave">1</span>
</div>
<div id="towerBar"></div>
<canvas id="c" width="600" height="400"></canvas>
</div>

<!-- å‡ç´šè¦–çª— -->
<div id="upgradeBox">
 <div id="upText" style="white-space:pre-line;margin-bottom:8px"></div>
 <button id="upYes">å‡ç´š</button>
 <button onclick="closeUpgrade()">å–æ¶ˆ</button>
</div>

<script>
/* ========= åŸºæœ¬ UI ========= */
const menu=document.getElementById('menu');
const game=document.getElementById('game');
const goldSpan=document.getElementById('gold');
const lifeSpan=document.getElementById('life');
const waveSpan=document.getElementById('wave');
const towerBar=document.getElementById('towerBar');
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');

/* ========= å­˜æª” ========= */
let save=JSON.parse(localStorage.getItem('tdSave'))||
 {tokens:200,owned:['æ™®é€šå¡”','çˆ†ç‚¸å¡”','å†°å‡å¡”','åœ‹ç‹å¡”']};
let tokens=save.tokens;
let owned=[...new Set(save.owned)];
const tokenSpan=document.getElementById('token');
const ownedSpan=document.getElementById('owned');

function refreshMenu(){
 tokenSpan.textContent=tokens;
 ownedSpan.textContent=owned.join(', ');
}
refreshMenu();

/* ========= æŠ½å¡ ========= */
function openGacha(){
 if(tokens<50) return alert('ä»£å¹£ä¸è¶³');
 tokens-=50;
 const r=Math.random();
 let t=r<0.7?'æ™®é€šå¡”':r<0.9?'çˆ†ç‚¸å¡”':r<0.99?'å†°å‡å¡”':'åœ‹ç‹å¡”';
 if(!owned.includes(t)) owned.push(t);
 localStorage.setItem('tdSave',JSON.stringify({tokens,owned}));
 refreshMenu();
 alert('æŠ½åˆ°ï¼š'+t);
}

/* ========= éŠæˆ²ç‹€æ…‹ ========= */
let gold,life,wave;
let towers=[],enemies=[],bullets=[],soldiers=[];
let selectedType=null;
let enemyTimer,spawnedThisWave;
const enemiesPerWave=8;

/* ========= å¡”æ•¸å€¼ ========= */
const towerStats={
 'æ™®é€šå¡”':{cost:50,d:20,r:160,rate:700,color:'#3498db'},
 'çˆ†ç‚¸å¡”':{cost:90,d:80,r:120,rate:2200,color:'#e67e22',aoe:80},
 'å†°å‡å¡”':{cost:80,d:36,r:140,rate:900,color:'#5dade2',slow:120},
 'åœ‹ç‹å¡”':{cost:120,rate:1000,color:'#f1c40f'}
};

/* ========= å¡”åˆ— ========= */
function buildTowerBar(){
 towerBar.innerHTML='';
 owned.forEach(t=>{
  const b=document.createElement('button');
  b.textContent=`${t} ($${towerStats[t].cost})`;
  b.onclick=()=>{
   selectedType=t;
   document.querySelectorAll('#towerBar button')
    .forEach(x=>x.classList.remove('active'));
   b.classList.add('active');
  };
  towerBar.appendChild(b);
 });
}

/* ========= é»æ“Šæ”¾å¡” / å‡ç´š ========= */
let upgrading=false,upgradeTarget=null;

canvas.onclick=e=>{
 const rect=canvas.getBoundingClientRect();
 const x=(e.clientX-rect.left)*(600/rect.width);
 const y=(e.clientY-rect.top)*(400/rect.height);

 for(const t of towers){
  if(Math.hypot(t.x-x,t.y-y)<16){
   const cost=40*t.lv;
   upgradeTarget=t;
   document.getElementById('upText').textContent=
`${t.type} Lv.${t.lv} â†’ Lv.${t.lv+1}

å‚·å®³ï¼š${t.d??'-'} â†’ ${t.d?Math.round(t.d*1.3):'-'}
å°„ç¨‹ï¼š${t.r??'-'} â†’ ${t.r?t.r+10:'-'}
æ”»é€Ÿï¼š${(t.rate/1000).toFixed(2)}s â†’ ${(Math.max(300,t.rate*0.9)/1000).toFixed(2)}s

èŠ±è²»ï¼š$${cost}`;
   document.getElementById('upgradeBox').style.display='block';
   upgrading=true;
   document.getElementById('upYes').onclick=()=>{
    if(gold<cost) return alert('é‡‘éŒ¢ä¸è¶³');
    gold-=cost;
    t.lv++;
    if(t.d) t.d=Math.round(t.d*1.3);
    if(t.r) t.r+=10;
    t.rate=Math.max(300,t.rate*0.9);
    closeUpgrade();
   };
   return;
  }
 }

 if(!selectedType) return;
 const s=towerStats[selectedType];
 if(gold<s.cost) return alert('é‡‘éŒ¢ä¸è¶³');
 gold-=s.cost;
 towers.push({x,y,type:selectedType,last:0,lv:1,...s});
};

function closeUpgrade(){
 document.getElementById('upgradeBox').style.display='none';
 upgrading=false;
 upgradeTarget=null;
}

/* ========= ç”Ÿæˆæ€ª ========= */
let bossBar=null;
let waveText='',waveTextTimer=0;
function showWaveText(t){waveText=t;waveTextTimer=120}

function spawnEnemy(){
 let type='normal';
 if(spawnedThisWave===enemiesPerWave-1){
  if(wave%10===0) type='boss';
  else if(wave%5===0) type='elite';
 }
 let hp,speed,color,name='';
 if(type==='boss'){
  hp=1600+wave*220;speed=0.5;color='#9b59b6';name='ğŸ‘‘ å¤§ç‹';
  showWaveText('ğŸ’€ BOSS å‡ºç¾ï¼');
 }else if(type==='elite'){
  hp=600+wave*150;speed=0.8;color='#e74c3c';name='âš  å°ç‹';
  showWaveText('âš  å°ç‹å‡ºç¾ï¼');
 }else{
  hp=80+wave*30;speed=1.5;color='#c0392b';
 }
 const e={x:-20,y:200,hp,max:hp,speed,slow:0,type,color,name,dead:false};
 enemies.push(e);
 if(type!=='normal') bossBar=e;
}

/* ========= ä¸»è¿´åœˆ ========= */
function loop(){
 ctx.clearRect(0,0,600,400);

 // é“è·¯
 ctx.strokeStyle='#555';ctx.lineWidth=6;
 ctx.beginPath();ctx.moveTo(0,200);ctx.lineTo(600,200);ctx.stroke();

 // ç”Ÿæ€ª
 enemyTimer++;
 if(enemyTimer>=0 && spawnedThisWave<enemiesPerWave && enemyTimer%60===0){
  spawnEnemy();spawnedThisWave++;
 }
 if(spawnedThisWave>=enemiesPerWave && enemies.length===0){
  wave++;spawnedThisWave=0;enemyTimer=-120;
 }

 // æ•µäºº
 enemies.forEach(e=>{
  let blocked=false;
  for(const s of soldiers){
   if(Math.abs(s.x-e.x)<12){blocked=true;break}
  }
  let sp=e.speed*(e.slow>0?0.5:1);
  if(e.slow>0) e.slow--;
  if(!blocked) e.x+=sp;
  if(e.x>600){life--;e.dead=true}
 });

 // å¡”
 towers.forEach(t=>{
  ctx.fillStyle=t.color;
  ctx.beginPath();ctx.arc(t.x,t.y,14+t.lv,0,Math.PI*2);ctx.fill();

  if(t.type!=='åœ‹ç‹å¡”' && Date.now()-t.last>t.rate){
   const e=enemies.find(e=>Math.hypot(e.x-t.x,e.y-t.y)<t.r);
   if(e){
    bullets.push({x:t.x,y:t.y,target:e,d:t.d,aoe:t.aoe,slow:t.slow});
    t.last=Date.now();
   }
  }

  if(t.type==='åœ‹ç‹å¡”' && Date.now()-t.last>1000){
   soldiers.push({x:600,y:200,hp:300,max:300,speed:-1.5});
   t.last=Date.now();
  }
 });

 // å­å½ˆ
 bullets.forEach(b=>{
  if(!b.target||b.target.dead){b.done=true;return}
  const dx=b.target.x-b.x,dy=b.target.y-b.y;
  const d=Math.hypot(dx,dy)||1;
  b.x+=dx/d*6;b.y+=dy/d*6;
  ctx.fillStyle='yellow';
  ctx.beginPath();ctx.arc(b.x,b.y,3,0,Math.PI*2);ctx.fill();
  if(d<6){
   if(b.aoe){
    enemies.forEach(e=>{
     if(Math.hypot(e.x-b.target.x,e.y-b.target.y)<b.aoe)
      e.hp-=b.d;
    });
   }else b.target.hp-=b.d;
   if(b.slow) b.target.slow=b.slow;
   b.done=true;
  }
 });
 bullets=bullets.filter(b=>!b.done);

 // å°å…µ
 soldiers.forEach(s=>{
  s.x+=s.speed;
  enemies.forEach(e=>{
   if(Math.abs(e.x-s.x)<10 && s.hp>0){
    const dmg=Math.min(s.hp,e.hp);
    e.hp-=dmg;s.hp-=dmg;
   }
  });
  ctx.fillStyle='#2ecc71';
  ctx.beginPath();ctx.arc(s.x,s.y,6,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='lime';
  ctx.fillRect(s.x-8,s.y-10,16*(s.hp/s.max),3);
 });
 soldiers=soldiers.filter(s=>s.hp>0&&s.x>0);

 // æ•µäººé¡¯ç¤º
 enemies.forEach(e=>{
  if(e.hp<=0){
   gold+=e.type==='boss'?200:e.type==='elite'?80:20;
   e.dead=true;
  }
  ctx.fillStyle=e.color;
  ctx.beginPath();ctx.arc(e.x,e.y,8,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='lime';
  ctx.fillRect(e.x-12,e.y-16,24*(e.hp/e.max),4);
  ctx.fillStyle='#fff';
  ctx.font='10px Arial';
  ctx.fillText(Math.ceil(e.hp),e.x-10,e.y-20);
 });
 enemies=enemies.filter(e=>!e.dead);

 // Boss è¡€æ¢
 if(bossBar && !bossBar.dead){
  ctx.fillStyle='rgba(0,0,0,0.8)';
  ctx.fillRect(20,8,560,40);
  ctx.fillStyle=bossBar.color;
  ctx.fillRect(24,12,552*(bossBar.hp/bossBar.max),32);
  ctx.strokeStyle='#fff';ctx.strokeRect(20,8,560,40);
  ctx.fillStyle='#fff';ctx.font='bold 16px Arial';ctx.textAlign='center';
  ctx.fillText(`${bossBar.name} HP ${Math.ceil(bossBar.hp)}/${bossBar.max}`,300,34);
  ctx.textAlign='left';
 }

 // æ³¢æ¬¡æç¤º
 if(waveTextTimer>0){
  ctx.fillStyle='rgba(0,0,0,0.65)';
  ctx.fillRect(0,140,600,100);
  ctx.fillStyle='#f1c40f';
  ctx.font='bold 28px Arial';
  ctx.textAlign='center';
  ctx.fillText(waveText,300,200);
  ctx.textAlign='left';
  waveTextTimer--;
 }

 goldSpan.textContent=gold;
 lifeSpan.textContent=life;
 waveSpan.textContent=wave;

 if(life<=0){
  const reward=wave*20;
  tokens+=reward;
  alert(`éŠæˆ²çµæŸï¼\nç²å¾—ä»£å¹£ï¼š${reward}`);
  localStorage.setItem('tdSave',JSON.stringify({tokens,owned}));
  game.style.display='none';
  menu.style.display='flex';
  refreshMenu();
  return;
 }

 requestAnimationFrame(loop);
}

/* ========= é–‹å§‹ ========= */
function startGame(){
 menu.style.display='none';
 game.style.display='block';
 towers=[];enemies=[];bullets=[];soldiers=[];
 gold=300;life=10;wave=1;
 enemyTimer=-120;spawnedThisWave=0;
 buildTowerBar();
 loop();
}
</script>
</body>
</html>



